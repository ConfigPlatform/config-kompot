{
  "handlers": [
    {
      "name": "invoice_search",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "invoicesGetRes",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "invoice",
          "from": {
            "table": "invoice"
          },
          "leftJoinAndSelect": {
            "column": "invoice.client",
            "table": "client"
          },
          "itemsPerPage": 10,
          "getManyAndCount": true,
          "awaitResult": true,
          "assignToVar": "invoicesGetRes"
        },
        {
          "type": "RETURN",
          "data": {
            "items": "$invoicesGetRes[0]",
            "totalCount": "$invoicesGetRes[1]",
            "pagination": {
              "itemsPerPage": 10
            }
          },
          "config": null
        }
      ]
    },
    {
      "name": "client_get_by_id",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "client",
          "value": "{}",
          "as": "let"
        },
        {
          "type": "CONDITION",
          "condition": "!$data.params.id",
          "onMatch": [
            {
              "type": "RETURN",
              "data": "$client",
              "config": []
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "client",
          "from": {
            "table": "client"
          },
          "where": {
            "table": "client",
            "filters": {
              "id": "$data.params.id"
            }
          },
          "awaitResult": true,
          "getOne": true,
          "assignToVar": "client"
        },
        {
          "type": "RETURN",
          "data": "$client",
          "config": []
        }
      ]
    },
    {
      "name": "invoice_get_by_client",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "invoices",
          "value": "[]",
          "as": "let"
        },
        {
          "type": "CONDITION",
          "condition": "!$data.params.id",
          "onMatch": [
            {
              "type": "RETURN",
              "data": "$invoices",
              "config": []
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": [
            {
              "column": "invoice.id",
              "alias": "id"
            },
            {
              "column": "SUM(payment.amount)",
              "alias": "paymentSum"
            },
            {
              "column": "invoice.amount",
              "alias": "amount"
            },
            {
              "column": "invoice.status",
              "alias": "status"
            }
          ],
          "from": {
            "table": "invoice"
          },
          "leftJoin": {
            "table": "payment",
            "condition": "payment.invoiceId = invoice.id"
          },
          "where": {
            "table": "invoice",
            "filters": {
              "client": "$data.params.id"
            }
          },
          "groupBy": "invoice.id",
          "getRawMany": true,
          "awaitResult": true,
          "assignToVar": "invoices"
        },
        {
          "type": "RETURN",
          "data": "$invoices",
          "config": null
        }
      ]
    },
    {
      "name": "payment_get_by_client",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "payments",
          "value": "[]",
          "as": "let"
        },
        {
          "type": "CONDITION",
          "condition": "!$data.params.id",
          "onMatch": [
            {
              "type": "RETURN",
              "data": "$payments",
              "config": []
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "payment",
          "from": {
            "table": "payment"
          },
          "leftJoinAndSelect": {
            "column": "payment.invoice",
            "table": "invoice"
          },
          "where": {
            "table": "payment",
            "filters": {
              "client": "$data.params.id"
            }
          },
          "getMany": true,
          "awaitResult": true,
          "assignToVar": "payments"
        },
        {
          "type": "RETURN",
          "data": "$payments",
          "config": null
        }
      ]
    },
    {
      "name": "client_search",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "clientsGetRes",
          "value": "null",
          "as": "let"
        },
        {
          "type": "CONDITION",
          "condition": "$data.filters && $data.sorting",
          "onMatch": [
            {
              "type": "TABLE_DATA_SELECT",
              "select": "client",
              "from": {
                "table": "client"
              },
              "where": {
                "table": "client",
                "filters": "$data.filters"
              },
              "orderBy": {
                "client.id": "$data.sorting.id"
              },
              "itemsPerPage": 10,
              "getManyAndCount": true,
              "awaitResult": true,
              "assignToVar": "clientsGetRes"
            },
            {
              "type": "RETURN",
              "data": {
                "items": "$clientsGetRes[0]",
                "totalCount": "$clientsGetRes[1]",
                "pagination": {
                  "itemsPerPage": 10
                }
              },
              "config": null
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "CONDITION",
          "condition": "!$data.filters && !$data.sorting",
          "onMatch": [
            {
              "type": "TABLE_DATA_SELECT",
              "select": "client",
              "from": {
                "table": "client"
              },
              "itemsPerPage": 10,
              "getManyAndCount": true,
              "awaitResult": true,
              "assignToVar": "clientsGetRes"
            },
            {
              "type": "RETURN",
              "data": {
                "items": "$clientsGetRes[0]",
                "totalCount": "$clientsGetRes[1]",
                "pagination": {
                  "itemsPerPage": 10
                }
              },
              "config": null
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "CONDITION",
          "condition": "$data.filters",
          "onMatch": [
            {
              "type": "TABLE_DATA_SELECT",
              "select": "client",
              "from": {
                "table": "client"
              },
              "where": {
                "table": "client",
                "filters": "$data.filters"
              },
              "itemsPerPage": 10,
              "getManyAndCount": true,
              "awaitResult": true,
              "assignToVar": "clientsGetRes"
            },
            {
              "type": "RETURN",
              "data": {
                "items": "$clientsGetRes[0]",
                "totalCount": "$clientsGetRes[1]",
                "pagination": {
                  "itemsPerPage": 10
                }
              },
              "config": null
            }
          ],
          "onNotMatch": []
        },
        {
          "type": "CONDITION",
          "condition": "$data.sorting",
          "onMatch": [
            {
              "type": "TABLE_DATA_SELECT",
              "select": "client",
              "from": {
                "table": "client"
              },
              "orderBy": {
                "client.id": "$data.sorting.id"
              },
              "itemsPerPage": 10,
              "getManyAndCount": true,
              "awaitResult": true,
              "assignToVar": "clientsGetRes"
            },
            {
              "type": "RETURN",
              "data": {
                "items": "$clientsGetRes[0]",
                "totalCount": "$clientsGetRes[1]",
                "pagination": {
                  "itemsPerPage": 10
                }
              },
              "config": null
            }
          ],
          "onNotMatch": []
        }
      ]
    },
    {
      "name": "open_invoice_create_sidepanel",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_OPEN",
              "id": "create_invoice"
            }
          ]
        }
      ]
    },
    {
      "name": "close_invoice_create_sidepanel",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_invoice"
            }
          ]
        }
      ]
    },
    {
      "name": "invoice_create_sidepanel_submit",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "client",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "client",
          "from": {
            "table": "client"
          },
          "where": {
            "table": "client",
            "filters": {
              "id": "$data.client"
            }
          },
          "getOne": true,
          "awaitResult": true,
          "assignToVar": "client"
        },
        {
          "type": "TABLE_RECORD_CREATE",
          "table": "invoice",
          "data": {
            "amount": "$data.amount",
            "status": "draft",
            "client": "$client.id"
          },
          "awaitResult": true
        },
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_invoice"
            },
            {
              "clientHandler": "DATA_REFRESH",
              "select": "invoice_search"
            },
            {
              "clientHandler": "MESSAGE_DISPLAY",
              "id": "invoice_created",
              "status": "success",
              "duration": 2000,
              "placement": "top-right",
              "content": "Invoice was created"
            }
          ]
        }
      ]
    },
    {
      "name": "client_delete_by_id",
      "actions": [
        {
          "type": "TABLE_RECORD_DELETE",
          "from": {
            "table": "client"
          },
          "where": {
            "table": "client",
            "filters": {
              "id": "$data.clientId"
            }
          },
          "awaitResult": true
        },
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "DATA_REFRESH",
              "select": "client_search"
            },
            {
              "clientHandler": "MESSAGE_DISPLAY",
              "id": "client_deleted",
              "status": "success",
              "duration": 2000,
              "placement": "top-right",
              "content": "Client was deleted"
            }
          ]
        }
      ]
    },
    {
      "name": "open_client_create_sidepanel",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_OPEN",
              "id": "create_client"
            }
          ]
        }
      ]
    },
    {
      "name": "close_client_create_sidepanel",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_client"
            }
          ]
        }
      ]
    },
    {
      "name": "client_create_sidepanel_submit",
      "actions": [
        {
          "type": "TABLE_RECORD_CREATE",
          "table": "client",
          "data": "$data",
          "awaitResult": true
        },
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_client"
            },
            {
              "clientHandler": "DATA_REFRESH",
              "select": "client_search"
            },
            {
              "clientHandler": "MESSAGE_DISPLAY",
              "id": "client_created",
              "status": "success",
              "duration": 2000,
              "placement": "top-right",
              "content": "Client was created"
            }
          ]
        }
      ]
    },
    {
      "name": "invoice_create_default_values",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "clients",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "client",
          "from": {
            "table": "client"
          },
          "getMany": true,
          "awaitResult": true,
          "assignToVar": "clients"
        },
        {
          "type": "VARIABLE_UPDATE",
          "variable": "clients",
          "value": "$clients.map(el => ({ label: el.name, value: el.id }))"
        },
        {
          "type": "RETURN",
          "data": "{ $clients }",
          "config": null
        }
      ]
    },
    {
      "name": "payment_search",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "paymentsGetRes",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "payment",
          "from": {
            "table": "payment"
          },
          "leftJoinAndSelect": [
            {
              "column": "payment.client",
              "table": "client"
            },
            {
              "column": "payment.invoice",
              "table": "invoice"
            }
          ],
          "itemsPerPage": 10,
          "getManyAndCount": true,
          "awaitResult": true,
          "assignToVar": "paymentsGetRes"
        },
        {
          "type": "RETURN",
          "data": {
            "items": "$paymentsGetRes[0]",
            "totalCount": "$paymentsGetRes[1]",
            "pagination": {
              "itemsPerPage": 10
            }
          },
          "config": null
        }
      ]
    },
    {
      "name": "payment_create_sidepanel_submit",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "invoice",
          "value": "null",
          "as": "let"
        },
        {
          "type": "VARIABLE_DEFINE",
          "name": "client",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "invoice",
          "from": {
            "table": "invoice"
          },
          "leftJoinAndSelect": {
            "column": "invoice.client",
            "table": "client"
          },
          "where": {
            "table": "invoice",
            "filters": {
              "id": "$data.invoice"
            }
          },
          "getOne": true,
          "awaitResult": true,
          "assignToVar": "invoice"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "client",
          "from": {
            "table": "client"
          },
          "where": {
            "table": "client",
            "filters": {
              "id": "$invoice.client.id"
            }
          },
          "getOne": true,
          "awaitResult": true,
          "assignToVar": "client"
        },
        {
          "type": "TABLE_RECORD_CREATE",
          "table": "payment",
          "data": {
            "amount": "$data.amount",
            "invoice": "$data.invoice",
            "client": "$invoice.client.id"
          },
          "awaitResult": true
        },
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_payment"
            },
            {
              "clientHandler": "DATA_REFRESH",
              "select": "payment_search"
            },
            {
              "clientHandler": "MESSAGE_DISPLAY",
              "id": "payment_created",
              "status": "success",
              "duration": 2000,
              "placement": "top-right",
              "content": "Payment was created"
            }
          ]
        }
      ]
    },
    {
      "name": "payment_create_sidepanel_close",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_CLOSE",
              "id": "create_payment"
            }
          ]
        }
      ]
    },
    {
      "name": "payment_create_sidepanel_open",
      "actions": [
        {
          "type": "RETURN",
          "config": [
            {
              "clientHandler": "SIDEPANEL_OPEN",
              "id": "create_payment"
            }
          ]
        }
      ]
    },
    {
      "name": "payment_create_default_values",
      "actions": [
        {
          "type": "VARIABLE_DEFINE",
          "name": "invoices",
          "value": "null",
          "as": "let"
        },
        {
          "type": "TABLE_DATA_SELECT",
          "select": "invoice",
          "from": {
            "table": "invoice"
          },
          "leftJoinAndSelect": {
            "column": "invoice.client",
            "table": "client"
          },
          "getMany": true,
          "awaitResult": true,
          "assignToVar": "invoices"
        },
        {
          "type": "VARIABLE_UPDATE",
          "variable": "invoices",
          "value": "$invoices.map(el => ({ label: '#' + el.id + ' ' + el.client.name, value: el.id }))"
        },
        {
          "type": "RETURN",
          "data": "{ $invoices }",
          "config": null
        }
      ]
    }
  ]
}
